description: >
  This jobs patches infra with new image tag.
  Exposed environment variables: GIT_USER_NAME, GIT_USER_EMAIL, IMAGE_NAME, IMAGE_TAG, GIT_INFRA_REPO, GIT_INFRA_ACCOUNT, INFRA_APP_PATH, INFRA_NAMESPACE, CONTAINER_NAME

parameters:
  image-name:
    type: string
    description: docker image name

  image-tag:
    type: env_var_name
    default: CIRCLE_TAG
    description: environment variable name with docker image tag, default value is CIRCLE_TAG

  git-user-name:
    type: string
    default: superbet-ci
    description: git user name, default value is superbet-ci

  git-user-email:
    type: string
    default: superbet@axilis.com
    description: git user email, default value is superbet@axilis.com

  git-infra-account:
    type: env_var_name
    default: CIRCLE_PROJECT_USERNAME
    description: git infrastructure account, default value is taken from CIRCLE_PROJECT_USERNAME environment variable

  git-infra-repo:
    type: string
    description: git infrastructure repository

  infra-app-path:
    type: string
    description: relative path to deployment manifest in Git infrastructure repository

  infra-namespace:
    type: string
    description: kubernetes namespace where infrastructure is deployed

  container-name:
    type: string
    description: docker image tag

  kubectl-version:
    type: string
    default: v1.12.2
    description: kubectl semantic version, default value is v1.12.2

shell: /bin/bash --login -eo pipefail

executor: python-node

working_directory: ~/infrastructure

environment:
  IMAGE_NAME: <<parameters.image-name>>
  IMAGE_TAG: \!<<parameters.image-tag>>
  GIT_USER_NAME: <<parameters.git-user-name>>
  GIT_USER_EMAIL: <<parameters.git-user-email>>
  GIT_INFRA_ACCOUNT: \!<<parameters.git-infra-account>>
  GIT_INFRA_REPO: <<parameters.git-infra-repo>>
  INFRA_APP_PATH: <<parameters.infra-app-path>>
  INFRA_NAMESPACE: <<parameters.infra-namespace>>
  CONTAINER_NAME: <<parameters.container-name>>

steps:
  - checkout:
      path: ~/app
  - git-clone
  - kubernetes/install-kubectl:
      kubectl-version: <<parameters.kubectl-version>>
  - patch-create
  - patch-apply
  - git-commit-push
