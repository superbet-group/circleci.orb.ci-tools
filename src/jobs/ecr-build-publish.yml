description: >
  This jobs publishes docker image to ECR.
  Exposed environment variables can be used in extra-build-args interpolation.
  Exposed environment variables: IMAGE_NAME, IMAGE_TAG_VAR_NAME

parameters:
  image-name:
    type: string
    description: Docker image name

  image-tag:
    type: env_var_name
    default: CIRCLE_TAG
    description: environment variable name with docker image tag, default value is CIRCLE_TAG

  extra-build-args:
    type: string
    description: Extra flags to pass to docker build
    default: ""

shell: /bin/bash --login -eo pipefail

executor: python-node

working_directory: ~/app

steps:
  - checkout
  - setup_remote_docker:
      version: 19.03.13
      docker_layer_caching: true
  - aws-cli/install
  - aws-ecr/ecr-login
  - docker/check
  - aws-ecr/build-and-push-image:
      checkout: false
      repo: <<parameters.image-name>>
      tag: ${<<parameters.image-tag>>}
      extra-build-args: <<parameters.extra-build-args>>
      create-repo: true
